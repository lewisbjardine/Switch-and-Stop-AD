<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Switch & Stop AD</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Simple NHS-like styling -->
  <style>
    :root {
      --nhs-blue: #005eb8;
      --nhs-light-blue: #e5f0f9;
      --nhs-grey: #425563;
      --nhs-white: #ffffff;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f5f5f5;
      color: #222;
    }

    header {
      background: var(--nhs-blue);
      color: var(--nhs-white);
      padding: 1rem 1.5rem;
    }

    header h1 {
      margin: 0;
      font-size: 1.5rem;
    }

    header p {
      margin: 0.25rem 0 0;
      font-size: 0.9rem;
      opacity: 0.9;
    }

    main {
      max-width: 960px;
      margin: 1.5rem auto;
      padding: 0 1rem 2rem;
    }

    .tabs {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
      flex-wrap: wrap;
    }

    .tab-button {
      border: 1px solid var(--nhs-blue);
      background: var(--nhs-white);
      color: var(--nhs-blue);
      padding: 0.5rem 0.9rem;
      border-radius: 999px;
      font-size: 0.95rem;
      cursor: pointer;
    }

    .tab-button.active {
      background: var(--nhs-blue);
      color: var(--nhs-white);
    }

    .card {
      background: var(--nhs-white);
      border-radius: 0.5rem;
      padding: 1rem 1.2rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.06);
      margin-bottom: 1rem;
    }

    .card h2 {
      margin-top: 0;
      font-size: 1.2rem;
      color: var(--nhs-grey);
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 0.8rem 1.5rem;
    }

    .field label {
      display: block;
      font-size: 0.9rem;
      font-weight: 600;
      margin-bottom: 0.25rem;
    }

    .field select,
    .field input {
      width: 100%;
      padding: 0.4rem 0.5rem;
      font-size: 0.95rem;
      border-radius: 0.25rem;
      border: 1px solid #ccc;
    }

    .button-row {
      margin-top: 1rem;
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    button.primary {
      background: var(--nhs-blue);
      color: var(--nhs-white);
      border: none;
      padding: 0.6rem 1.1rem;
      font-size: 0.95rem;
      border-radius: 0.3rem;
      cursor: pointer;
    }

    button.secondary {
      background: var(--nhs-light-blue);
      color: var(--nhs-grey);
      border: none;
      padding: 0.6rem 1.1rem;
      font-size: 0.9rem;
      border-radius: 0.3rem;
      cursor: pointer;
    }

    .outputs {
      display: grid;
      grid-template-columns: 1fr;
      gap: 1rem;
    }

    @media (min-width: 768px) {
      .outputs {
        grid-template-columns: 1fr 1fr;
      }
    }

    .output-box {
      padding: 0.5rem;
      border-radius: 0.3rem;
      background: #fafafa;
      border: 1px solid #ddd;
      font-family: "SFMono-Regular", ui-monospace, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.9rem;
      white-space: pre-wrap;
      word-wrap: break-word;
      min-height: 180px;
    }

    .output-label {
      font-size: 0.85rem;
      font-weight: 600;
      margin-bottom: 0.25rem;
      color: var(--nhs-grey);
    }

    .disclaimer {
      font-size: 0.8rem;
      color: #555;
      margin-top: 0.5rem;
    }

    a.guideline-link {
      color: var(--nhs-blue);
      text-decoration: none;
    }

    a.guideline-link:hover {
      text-decoration: underline;
    }

    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <header>
    <h1>Switch &amp; Stop AD</h1>
    <p>Helper for switching and stopping antidepressants in UK general practice (beta).</p>
  </header>

  <main>
    <div class="tabs">
      <button class="tab-button active" data-tab="switching">Switching</button>
      <button class="tab-button" data-tab="stopping">Stopping / cessation</button>
    </div>

    <!-- SWITCHING TAB -->
    <section id="switching" class="tab card">
      <h2>Switch between antidepressants</h2>
      <p style="font-size:0.9rem">
        Choose the current and new antidepressant. This tool generates a draft plan based on high-level
        principles from NICE NG222 and SPS switching strategies – always check full guidance for complex cases.
      </p>

      <div class="grid">
        <div class="field">
          <label for="fromDrug">Current antidepressant</label>
          <select id="fromDrug"></select>
        </div>
        <div class="field">
          <label for="fromDose">Current dose (mg/day)</label>
          <select id="fromDose"></select>
        </div>
        <div class="field">
          <label for="toDrug">New antidepressant</label>
          <select id="toDrug"></select>
        </div>
      </div>

      <div class="button-row">
        <button class="primary" id="generateSwitch">Generate plan</button>
        <button class="secondary" id="clearSwitch">Clear</button>
      </div>

      <div class="outputs" style="margin-top:1rem">
        <div>
          <div class="output-label">Clinician note (SystmOne/EMIS)</div>
          <div id="switchClinician" class="output-box"></div>
        </div>
        <div>
          <div class="output-label">Patient SMS version</div>
          <div id="switchSMS" class="output-box"></div>
        </div>
      </div>

      <p class="disclaimer">
        Sources (accessed 2025): NICE NG222 Depression in adults – stopping and switching antidepressants,
        NICE CKS Depression – switching antidepressants, SPS “Switching strategies for antidepressants” and
        related SSRI/SNRI/TCA switching articles.
      </p>
      <p class="disclaimer">
        Links: 
        <a class="guideline-link" href="https://www.nice.org.uk/guidance/ng222" target="_blank">NICE NG222</a> ·
        <a class="guideline-link" href="https://www.sps.nhs.uk/articles/switching-strategies-for-antidepressants/" target="_blank">SPS switching strategies</a> ·
        <a class="guideline-link" href="https://www.psychiatrienet.nl/switchtabel/show?id=SwitchAntidepressants" target="_blank">Psychiatrienet switch table</a>
      </p>
    </section>

    <!-- STOPPING TAB -->
    <section id="stopping" class="tab card hidden">
      <h2>Plan antidepressant cessation</h2>
      <p style="font-size:0.9rem">
        Generates a simple tapering schedule based on duration of treatment and basic pharmacokinetic
        considerations. Adapt to individual response and use your local/Trust guidance.
      </p>

      <div class="grid">
        <div class="field">
          <label for="stopDrug">Antidepressant</label>
          <select id="stopDrug"></select>
        </div>
        <div class="field">
          <label for="stopDose">Current dose (mg/day)</label>
          <select id="stopDose"></select>
        </div>
        <div class="field">
          <label for="duration">Duration of continuous use</label>
          <select id="duration">
            <option value="short">&lt; 6 weeks</option>
            <option value="medium">6 weeks – 6 months</option>
            <option value="long">6 – 24 months</option>
            <option value="very_long">&gt; 2 years</option>
          </select>
        </div>
      </div>

      <div class="button-row">
        <button class="primary" id="generateStop">Generate taper</button>
        <button class="secondary" id="clearStop">Clear</button>
      </div>

      <div class="outputs" style="margin-top:1rem">
        <div>
          <div class="output-label">Clinician note (SystmOne/EMIS)</div>
          <div id="stopClinician" class="output-box"></div>
        </div>
        <div>
          <div class="output-label">Patient SMS version</div>
          <div id="stopSMS" class="output-box"></div>
        </div>
      </div>

      <p class="disclaimer">
        Sources (accessed 2025): NICE NG222 &amp; QS8 “Stopping antidepressants”, RCPsych “Stopping antidepressants”
        information resource, SPS “Deprescribing of antidepressants for depression and anxiety”.
      </p>
      <p class="disclaimer">
        Links:
        <a class="guideline-link" href="https://www.nice.org.uk/guidance/ng222/chapter/Recommendations#stopping-antidepressant-medication" target="_blank">NICE NG222 stopping section</a> ·
        <a class="guideline-link" href="https://www.nice.org.uk/guidance/qs8/chapter/Quality-statement-4-Stopping-antidepressants" target="_blank">NICE QS8</a> ·
        <a class="guideline-link" href="https://www.rcpsych.ac.uk/mental-health/treatments-and-wellbeing/stopping-antidepressants" target="_blank">RCPsych – Stopping antidepressants</a> ·
        <a class="guideline-link" href="https://www.sps.nhs.uk/articles/deprescribing-of-antidepressants-for-depression-and-anxiety/" target="_blank">SPS deprescribing</a>
      </p>
    </section>

    <section class="card">
      <h2>Important disclaimer</h2>
      <p style="font-size:0.9rem">
        This tool is intended for use by healthcare professionals in UK primary care as an
        <strong>aide-mémoire</strong>. It does not replace full clinical assessment, shared decision-making,
        or local / national guidelines. Use with caution in pregnancy, bipolar disorder, recent self-harm,
        significant comorbidity or polypharmacy – consider specialist advice.
      </p>
    </section>
  </main>

  <script>
    // -------------------------
    // Antidepressant data
    // -------------------------
    const antidepressants = [
      {
        id: "sertraline",
        name: "Sertraline",
        class: "SSRI",
        commonDoses: [25, 50, 100, 150, 200],
        halfLife: "medium",
        withdrawalRisk: "medium"
      },
      {
        id: "fluoxetine",
        name: "Fluoxetine",
        class: "SSRI",
        commonDoses: [10, 20, 40, 60],
        halfLife: "long",
        withdrawalRisk: "low"
      },
      {
        id: "citalopram",
        name: "Citalopram",
        class: "SSRI",
        commonDoses: [10, 20, 40],
        halfLife: "medium",
        withdrawalRisk: "medium"
      },
      {
        id: "escitalopram",
        name: "Escitalopram",
        class: "SSRI",
        commonDoses: [5, 10, 20],
        halfLife: "medium",
        withdrawalRisk: "medium"
      },
      {
        id: "paroxetine",
        name: "Paroxetine",
        class: "SSRI",
        commonDoses: [10, 20, 30, 40],
        halfLife: "short",
        withdrawalRisk: "high"
      },
      {
        id: "mirtazapine",
        name: "Mirtazapine",
        class: "NaSSA",
        commonDoses: [15, 30, 45],
        halfLife: "medium",
        withdrawalRisk: "medium"
      },
      {
        id: "venlafaxine",
        name: "Venlafaxine MR",
        class: "SNRI",
        commonDoses: [37.5, 75, 150, 225],
        halfLife: "short",
        withdrawalRisk: "high"
      },
      {
        id: "duloxetine",
        name: "Duloxetine",
        class: "SNRI",
        commonDoses: [30, 60, 90, 120],
        halfLife: "medium",
        withdrawalRisk: "medium"
      }
      // You can add TCAs, vortioxetine, etc. here later
    ];

    // Sort commonly used first (already ordered), then alphabetically if you expand
    const sortedAntidepressants = antidepressants; // for now as defined

    // -------------------------
    // Utility functions
    // -------------------------
    function populateDrugSelect(selectEl) {
      selectEl.innerHTML = "";
      sortedAntidepressants.forEach(drug => {
        const opt = document.createElement("option");
        opt.value = drug.id;
        opt.textContent = drug.name;
        selectEl.appendChild(opt);
      });
    }

    function populateDoseSelect(drugId, selectEl) {
      const drug = sortedAntidepressants.find(d => d.id === drugId);
      selectEl.innerHTML = "";
      if (!drug) return;
      drug.commonDoses.forEach(dose => {
        const opt = document.createElement("option");
        opt.value = dose;
        opt.textContent = dose;
        selectEl.appendChild(opt);
      });
    }

    function getDrugById(id) {
      return sortedAntidepressants.find(d => d.id === id);
    }

    // -------------------------
    // Switching logic (simple starter)
    // -------------------------
    function generateSwitchPlan(fromDrugId, fromDose, toDrugId) {
      const from = getDrugById(fromDrugId);
      const to = getDrugById(toDrugId);
      const dose = Number(fromDose);

      if (!from || !to || from.id === to.id) {
        return {
          clinician: "Please select two different antidepressants.",
          sms: ""
        };
      }

      // high-level strategy: direct vs cross-taper
      let strategy = "";
      let weeks = [];
      let cautions = [];

      if (from.class === "SSRI" && to.class === "SSRI") {
        // SSRI -> SSRI
        if (from.id === "fluoxetine" || to.id === "fluoxetine") {
          // Include reminder about long half-life
          strategy = "direct_with_caution";
        } else {
          strategy = "direct";
        }
      } else if (from.class === "SSRI" && (to.class === "SNRI" || to.class === "NaSSA")) {
        strategy = "cross_taper_2_4w";
      } else if ((from.class === "SNRI" || from.class === "NaSSA") && to.class === "SSRI") {
        strategy = "cross_taper_2_4w";
      } else {
        strategy = "simple_cross_taper";
      }

      if (strategy === "direct") {
        weeks.push(`Stop ${from.name} ${dose} mg once daily and start ${to.name} at usual starting dose the following day (e.g. ${to.commonDoses[0]} mg once daily).`);
      } else if (strategy === "direct_with_caution") {
        weeks.push(
          `Stop ${from.name} ${dose} mg once daily and start ${to.name} at usual starting dose the following day.`,
          `Be aware of fluoxetine's long half-life; monitor for interactions and adverse effects for several weeks.`
        );
      } else {
        // Cross-taper: simple 2-week example, to be refined
        const halfDose = dose / 2;
        weeks.push(
          `Week 1: Reduce ${from.name} from ${dose} mg to ${halfDose} mg once daily. Start ${to.name} at usual starting dose (e.g. ${to.commonDoses[0]} mg once daily).`,
          `Week 2: Stop ${from.name}. Continue ${to.name}, increasing towards target dose as tolerated.`
        );
      }

      cautions.push(
        "Warned about potential transient increase in anxiety, GI upset, sleep disturbance and risk of serotonin syndrome during overlap.",
        "Advised to seek urgent help (111/999/A&E) if severe agitation, confusion, fever, sweating, tremor, diarrhoea or thoughts of self-harm develop."
      );

      const clinicianText =
        `Plan – switch from ${from.name} ${dose} mg OD to ${to.name}\n\n` +
        weeks.map((w, i) => `• ${w}`).join("\n") +
        `\n\nCounselling & safety net:\n` +
        cautions.map(c => `• ${c}`).join("\n") +
        `\n\nBased on high-level principles from NICE NG222 and SPS switching strategies – check full SPS tables and local guidance for this specific switch.`;

      const smsText =
        `Your medication plan\n\n` +
        `You are changing from ${from.name} ${dose} mg daily to ${to.name}.\n\n` +
        (strategy === "direct"
          ? `Stop ${from.name} and start ${to.name} at the usual starting dose the next day (your GP will confirm the exact dose).\n\n`
          : `Week 1: lower ${from.name} and start ${to.name} at a low dose.\nWeek 2: stop ${from.name} and continue ${to.name}.\n\n`) +
        `Contact the surgery, NHS 111 or 999/A&E urgently if you feel very agitated, confused, feverish, have severe diarrhoea or thoughts of harming yourself.`;

      return { clinician: clinicianText, sms: smsText };
    }

    // -------------------------
    // Stopping logic (simple proportional taper)
    // -------------------------
    function generateStopPlan(drugId, dose, durationBand) {
      const drug = getDrugById(drugId);
      const startDose = Number(dose);
      if (!drug || !startDose) {
        return {
          clinician: "Please select a drug and dose.",
          sms: ""
        };
      }

      // Decide number of steps based on duration
      let steps;
      switch (durationBand) {
        case "short":
          steps = 2;
          break;
        case "medium":
          steps = 3;
          break;
        case "long":
          steps = 4;
          break;
        case "very_long":
          steps = 6;
          break;
        default:
          steps = 3;
      }

      // Adjust for half-life / withdrawal risk
      if (drug.withdrawalRisk === "high" && steps < 4) {
        steps += 1;
      }
      if (drug.halfLife === "long" && steps > 3) {
        steps -= 1;
      }

      // Build taper schedule: proportional reductions
      const schedule = [];
      let current = startDose;
      for (let i = 1; i <= steps; i++) {
        const isLast = i === steps;
        if (isLast) {
          schedule.push({ step: i, dose: 0 });
        } else {
          current = Math.round((current * 0.5) * 10) / 10; // 50% each step, rounded
          if (current < 0.25 * startDose && current !== 0) {
            // avoid going too tiny too early
            current = Math.round((startDose * 0.25) * 10) / 10;
          }
          schedule.push({ step: i, dose: current });
        }
      }

      // Convert steps to weeks (rough guide)
      let weeksPerStep = 2;
      if (durationBand === "short") weeksPerStep = 1;
      if (durationBand === "very_long") weeksPerStep = 3;

      const lines = schedule.map((s, index) => {
        const startWeek = index * weeksPerStep + 1;
        const endWeek = (index + 1) * weeksPerStep;
        if (s.dose === 0) {
          return `Weeks ${startWeek}–${endWeek}: stop ${drug.name} if stable and withdrawal symptoms are manageable.`;
        } else {
          return `Weeks ${startWeek}–${endWeek}: ${drug.name} ${s.dose} mg once daily.`;
        }
      });

      const clinicianText =
        `Plan – gradual reduction of ${drug.name} ${startDose} mg OD (duration: ${durationBand.replace("_", " ")})\n\n` +
        lines.map(l => `• ${l}`).join("\n") +
        `\n\nCounselling & safety net:\n` +
        `• Explained rationale for gradual taper per NICE NG222 / QS8 and RCPsych guidance (proportional reductions, slower for short half-life / higher withdrawal risk drugs).\n` +
        `• Advised to monitor for withdrawal symptoms (dizziness, "electric shocks", flu-like symptoms, sleep disturbance, mood changes) and relapse of depression/anxiety.\n` +
        `• Advised to contact the surgery if withdrawal symptoms are severe/persistent or if depressive symptoms return; consider pausing or slowing taper.\n`;

      const smsText =
        `Plan to reduce ${drug.name}\n\n` +
        `You are on ${drug.name} ${startDose} mg daily. We will reduce slowly:\n` +
        lines.map(l => "- " + l.replace(`${drug.name} `, "")).join("\n") +
        `\n\nIf you get severe dizziness, strange "electric shock" feelings, very low mood or thoughts of harming yourself, contact the surgery, NHS 111 or 999/A&E urgently.`;

      return { clinician: clinicianText, sms: smsText };
    }

    // -------------------------
    // UI wiring
    // -------------------------
    document.addEventListener("DOMContentLoaded", () => {
      const fromDrugSelect = document.getElementById("fromDrug");
      const fromDoseSelect = document.getElementById("fromDose");
      const toDrugSelect = document.getElementById("toDrug");

      const stopDrugSelect = document.getElementById("stopDrug");
      const stopDoseSelect = document.getElementById("stopDose");
      const durationSelect = document.getElementById("duration");

      populateDrugSelect(fromDrugSelect);
      populateDrugSelect(toDrugSelect);
      populateDrugSelect(stopDrugSelect);

      // initial doses
      populateDoseSelect(fromDrugSelect.value, fromDoseSelect);
      populateDoseSelect(stopDrugSelect.value, stopDoseSelect);

      fromDrugSelect.addEventListener("change", () => {
        populateDoseSelect(fromDrugSelect.value, fromDoseSelect);
      });

      stopDrugSelect.addEventListener("change", () => {
        populateDoseSelect(stopDrugSelect.value, stopDoseSelect);
      });

      document.getElementById("generateSwitch").addEventListener("click", () => {
        const res = generateSwitchPlan(fromDrugSelect.value, fromDoseSelect.value, toDrugSelect.value);
        document.getElementById("switchClinician").textContent = res.clinician;
        document.getElementById("switchSMS").textContent = res.sms;
      });

      document.getElementById("clearSwitch").addEventListener("click", () => {
        document.getElementById("switchClinician").textContent = "";
        document.getElementById("switchSMS").textContent = "";
      });

      document.getElementById("generateStop").addEventListener("click", () => {
        const res = generateStopPlan(stopDrugSelect.value, stopDoseSelect.value, durationSelect.value);
        document.getElementById("stopClinician").textContent = res.clinician;
        document.getElementById("stopSMS").textContent = res.sms;
      });

      document.getElementById("clearStop").addEventListener("click", () => {
        document.getElementById("stopClinician").textContent = "";
        document.getElementById("stopSMS").textContent = "";
      });

      // Tab switching
      const tabButtons = document.querySelectorAll(".tab-button");
      const tabs = {
        switching: document.getElementById("switching"),
        stopping: document.getElementById("stopping")
      };

      tabButtons.forEach(btn => {
        btn.addEventListener("click", () => {
          tabButtons.forEach(b => b.classList.remove("active"));
          btn.classList.add("active");
          const tabId = btn.dataset.tab;
          Object.keys(tabs).forEach(id => {
            tabs[id].classList.toggle("hidden", id !== tabId);
          });
        });
      });
    });
  </script>
</body>
</html>
