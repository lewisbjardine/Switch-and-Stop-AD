<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Switch &amp; Stop AD</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root {
      --nhs-blue: #005eb8;
      --nhs-light-blue: #e5f0f9;
      --nhs-grey: #425563;
      --nhs-white: #ffffff;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f5f5f5;
      color: #222;
    }

    header {
      background: var(--nhs-blue);
      color: var(--nhs-white);
      padding: 1rem 1.5rem;
    }

    header h1 {
      margin: 0;
      font-size: 1.5rem;
    }

    header p {
      margin: 0.25rem 0 0;
      font-size: 0.9rem;
      opacity: 0.9;
    }

    main {
      max-width: 960px;
      margin: 1.5rem auto;
      padding: 0 1rem 2rem;
    }

    .tabs {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
      flex-wrap: wrap;
    }

    .tab-button {
      border: 1px solid var(--nhs-blue);
      background: var(--nhs-white);
      color: var(--nhs-blue);
      padding: 0.5rem 0.9rem;
      border-radius: 999px;
      font-size: 0.95rem;
      cursor: pointer;
    }

    .tab-button.active {
      background: var(--nhs-blue);
      color: var(--nhs-white);
    }

    .card {
      background: var(--nhs-white);
      border-radius: 0.5rem;
      padding: 1rem 1.2rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.06);
      margin-bottom: 1rem;
    }

    .card h2 {
      margin-top: 0;
      font-size: 1.2rem;
      color: var(--nhs-grey);
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 0.8rem 1.5rem;
    }

    .field label {
      display: block;
      font-size: 0.9rem;
      font-weight: 600;
      margin-bottom: 0.25rem;
    }

    .field select,
    .field input {
      width: 100%;
      padding: 0.4rem 0.5rem;
      font-size: 0.95rem;
      border-radius: 0.25rem;
      border: 1px solid #ccc;
      box-sizing: border-box;
    }

    .button-row {
      margin-top: 1rem;
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    button.primary {
      background: var(--nhs-blue);
      color: var(--nhs-white);
      border: none;
      padding: 0.6rem 1.1rem;
      font-size: 0.95rem;
      border-radius: 0.3rem;
      cursor: pointer;
    }

    button.secondary {
      background: var(--nhs-light-blue);
      color: var(--nhs-grey);
      border: none;
      padding: 0.6rem 1.1rem;
      font-size: 0.9rem;
      border-radius: 0.3rem;
      cursor: pointer;
    }

    button.primary:disabled,
    button.secondary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .outputs {
      display: grid;
      grid-template-columns: 1fr;
      gap: 1rem;
    }

    @media (min-width: 768px) {
      .outputs {
        grid-template-columns: 1fr 1fr;
      }
    }

    .output-box {
      padding: 0.5rem;
      border-radius: 0.3rem;
      background: #fafafa;
      border: 1px solid #ddd;
      font-family: "SFMono-Regular", ui-monospace, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.9rem;
      white-space: pre-wrap;
      word-wrap: break-word;
      min-height: 180px;
      clear: both;
    }

    .output-label {
      font-size: 0.85rem;
      font-weight: 600;
      margin-bottom: 0.25rem;
      color: var(--nhs-grey);
    }

    .disclaimer {
      font-size: 0.8rem;
      color: #555;
      margin-top: 0.5rem;
    }

    a.guideline-link {
      color: var(--nhs-blue);
      text-decoration: none;
    }

    a.guideline-link:hover {
      text-decoration: underline;
    }

    .hidden {
      display: none;
    }

    .copy-btn {
      float: right;
      margin-bottom: 4px;
      background: var(--nhs-blue);
      color: white;
      border: none;
      padding: 4px 10px;
      font-size: 0.8rem;
      border-radius: 4px;
      cursor: pointer;
    }

    .copy-btn.copied {
      background: #2e7d32;
    }

    /* Modal styling */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.4);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 999;
    }

    .modal {
      background: var(--nhs-white);
      max-width: 700px;
      width: 95%;
      max-height: 80vh;
      overflow-y: auto;
      border-radius: 0.5rem;
      padding: 1rem 1.2rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .modal h3 {
      margin-top: 0;
      font-size: 1.1rem;
      color: var(--nhs-grey);
    }

    .modal-options {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      margin-top: 0.5rem;
    }

    .modal-option {
      border: 1px solid #ddd;
      border-radius: 0.4rem;
      padding: 0.6rem 0.7rem;
      cursor: pointer;
      background: #fafafa;
    }

    .modal-option.selected {
      border-color: var(--nhs-blue);
      box-shadow: 0 0 0 1px var(--nhs-blue);
      background: #f0f6fd;
    }

    .modal-option-title {
      font-weight: 600;
      font-size: 0.95rem;
      margin-bottom: 0.25rem;
    }

    .modal-option-body {
      font-size: 0.85rem;
      white-space: pre-wrap;
    }

    .modal-footer {
      margin-top: 0.75rem;
      display: flex;
      justify-content: flex-end;
      gap: 0.5rem;
    }

    .modal-footer button {
      padding: 0.5rem 0.9rem;
      font-size: 0.9rem;
      border-radius: 0.3rem;
      border: none;
      cursor: pointer;
    }

    .btn-cancel {
      background: #eee;
      color: #333;
    }

    .btn-confirm {
      background: var(--nhs-blue);
      color: white;
    }

    .btn-confirm:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    footer {
      max-width: 960px;
      margin: 0 auto 1rem;
      padding: 0 1rem;
      font-size: 0.75rem;
      color: #777;
      text-align: right;
    }
  </style>
</head>
<body>
  <header>
    <h1>Switch &amp; Stop AD</h1>
    <p>Helper for switching and stopping antidepressants in UK general practice (beta).</p>
  </header>

  <main>
    <div class="tabs">
      <button class="tab-button active" data-tab="switching">Switching</button>
      <button class="tab-button" data-tab="stopping">Stopping / cessation</button>
    </div>

    <!-- SWITCHING TAB -->
    <section id="switching" class="tab card">
      <h2>Switch between antidepressants</h2>
      <p style="font-size:0.9rem">
        Choose the current and new antidepressant. This tool generates a draft plan based on high-level
        principles from NICE NG222 and SPS switching strategies. Always check full SPS / local guidance
        and use clinical judgement.
      </p>

      <div class="grid">
        <div class="field">
          <label for="fromDrug">Current antidepressant</label>
          <select id="fromDrug"></select>
        </div>
        <div class="field">
          <label for="fromDose">Current dose (mg/day)</label>
          <select id="fromDose"></select>
        </div>
        <div class="field">
          <label for="toDrug">New antidepressant</label>
          <select id="toDrug"></select>
        </div>
      </div>

      <div class="button-row">
        <button class="primary" id="generateSwitch">Generate plan</button>
        <button class="secondary" id="clearSwitch">Clear</button>
      </div>

      <div class="outputs" style="margin-top:1rem">
        <div>
          <div class="output-label">Clinician note (SystmOne/EMIS)</div>
          <button class="copy-btn" data-target="switchClinician">Copy</button>
          <div id="switchClinician" class="output-box"></div>
        </div>
        <div>
          <div class="output-label">Patient SMS version</div>
          <button class="copy-btn" data-target="switchSMS">Copy</button>
          <div id="switchSMS" class="output-box"></div>
        </div>
      </div>

      <p class="disclaimer">
        Sources (accessed 2025): NICE NG222 Depression in adults – starting and stopping antidepressants;
        NICE CKS Depression – switching antidepressants; SPS suite “Switching strategies for antidepressants”
        (including SSRIs, SNRIs, TCAs, MAOIs); Psychiatrienet switch table.
      </p>
      <p class="disclaimer">
        Links:
        <a class="guideline-link" href="https://www.nice.org.uk/guidance/ng222" target="_blank">NICE NG222</a> ·
        <a class="guideline-link" href="https://www.sps.nhs.uk/articles/switching-strategies-for-antidepressants/" target="_blank">SPS switching strategies</a> ·
        <a class="guideline-link" href="https://www.sps.nhs.uk/articles/ssris-to-other-antidepressants-switching-in-adults/" target="_blank">SPS SSRIs to other antidepressants</a> ·
        <a class="guideline-link" href="https://www.sps.nhs.uk/articles/snris-to-other-antidepressants-switching-in-adults/" target="_blank">SPS SNRIs to other antidepressants</a> ·
        <a class="guideline-link" href="https://www.psychiatrienet.nl/switchtabel/show?id=SwitchAntidepressants" target="_blank">Psychiatrienet switch table</a>
      </p>
    </section>

    <!-- STOPPING TAB -->
    <section id="stopping" class="tab card hidden">
      <h2>Plan antidepressant cessation</h2>
      <p style="font-size:0.9rem">
        Generates a proportional taper based on duration of use and withdrawal risk, using BNF-realistic tablet/capsule
        strengths. For drugs that cannot be tapered with available strengths, you can choose an intermediate agent to
        switch to for tapering.
      </p>

      <div class="grid">
        <div class="field">
          <label for="stopDrug">Antidepressant</label>
          <select id="stopDrug"></select>
        </div>
        <div class="field">
          <label for="stopDose">Current dose (mg/day)</label>
          <select id="stopDose"></select>
        </div>
        <div class="field">
          <label for="duration">Duration of continuous use</label>
          <select id="duration">
            <option value="short">&lt; 6 weeks</option>
            <option value="medium">6 weeks – 6 months</option>
            <option value="long">6 – 24 months</option>
            <option value="very_long">&gt; 2 years</option>
          </select>
        </div>
      </div>

      <div class="button-row">
        <button class="primary" id="generateStop">Generate taper</button>
        <button class="secondary" id="clearStop">Clear</button>
      </div>

      <div class="outputs" style="margin-top:1rem">
        <div>
          <div class="output-label">Clinician note (SystmOne/EMIS)</div>
          <button class="copy-btn" data-target="stopClinician">Copy</button>
          <div id="stopClinician" class="output-box"></div>
        </div>
        <div>
          <div class="output-label">Patient SMS version</div>
          <button class="copy-btn" data-target="stopSMS">Copy</button>
          <div id="stopSMS" class="output-box"></div>
        </div>
      </div>

      <p class="disclaimer">
        Sources (accessed 2025): NICE NG222 &amp; QS8 “Stopping antidepressants”; RCPsych “Stopping antidepressants”;
        SPS “Deprescribing of antidepressants for depression and anxiety”; proportional tapering literature (e.g. Horowitz &amp; Taylor).
      </p>
      <p class="disclaimer">
        Links:
        <a class="guideline-link" href="https://www.nice.org.uk/guidance/ng222/chapter/Recommendations#stopping-antidepressant-medication" target="_blank">NICE NG222 stopping section</a> ·
        <a class="guideline-link" href="https://www.nice.org.uk/guidance/qs8/chapter/Quality-statement-4-Stopping-antidepressants" target="_blank">NICE QS8</a> ·
        <a class="guideline-link" href="https://www.rcpsych.ac.uk/mental-health/treatments-and-wellbeing/stopping-antidepressants" target="_blank">RCPsych – Stopping antidepressants</a> ·
        <a class="guideline-link" href="https://www.sps.nhs.uk/articles/deprescribing-of-antidepressants-for-depression-and-anxiety/" target="_blank">SPS deprescribing</a>
      </p>
    </section>

    <section class="card">
      <h2>Important disclaimer</h2>
      <p style="font-size:0.9rem">
        This tool is intended for use by healthcare professionals in UK primary care as an
        <strong>aide-mémoire</strong>. It does not replace full clinical assessment, shared decision-making,
        or local / national guidelines. Use with particular caution in pregnancy, bipolar disorder,
        recent self-harm, significant comorbidity or polypharmacy – consider specialist advice.
      </p>
    </section>
  </main>

  <footer>
    Switch &amp; Stop AD – beta | Last updated: Dec 2025
  </footer>

  <!-- Modal for choosing taper pathway when direct taper is not possible -->
  <div id="taperModalOverlay" class="modal-overlay hidden" style="display:none;">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="taperModalTitle">
      <h3 id="taperModalTitle">Choose taper pathway</h3>
      <p id="taperModalIntro" style="font-size:0.85rem">
        This medication cannot be tapered safely using its available UK BNF strengths alone.
        Please choose which equivalent medication you would like to switch to first in order
        to taper more gradually. An example taper for each option is shown below.
      </p>
      <div id="taperModalOptions" class="modal-options"></div>
      <div class="modal-footer">
        <button class="btn-cancel" id="taperModalCancel">Cancel</button>
        <button class="btn-confirm" id="taperModalConfirm" disabled>Confirm choice</button>
      </div>
    </div>
  </div>

  <script>
    // ==========================
    // Global state
    // ==========================
    let userHasClickedGenerateStop = false;
    let pendingTaperContext = null; // {sourceDrugId, sourceDose, durationBand}
    let pendingTaperOptions = [];
    let selectedTaperOptionId = null;
    let lastFocusedElementBeforeModal = null;

    // ==========================
    // Antidepressant dataset
    // ==========================
    const antidepressants = [
      /* SSRIs */
      {
        id: "sertraline",
        name: "Sertraline",
        class: "SSRI",
        commonDoses: [25, 50, 75, 100, 150, 200],
        halfLife: "medium",
        withdrawalRisk: "medium",
        ukLicensed: true,
        requiresSwitchForTaper: false
      },
      {
        id: "fluoxetine",
        name: "Fluoxetine",
        class: "SSRI",
        commonDoses: [10, 20, 40],
        halfLife: "long",
        withdrawalRisk: "low",
        ukLicensed: true,
        requiresSwitchForTaper: false
      },
      {
        id: "citalopram",
        name: "Citalopram",
        class: "SSRI",
        commonDoses: [10, 20, 40],
        halfLife: "medium",
        withdrawalRisk: "medium",
        ukLicensed: true,
        requiresSwitchForTaper: false
      },
      {
        id: "escitalopram",
        name: "Escitalopram",
        class: "SSRI",
        commonDoses: [5, 10, 20],
        halfLife: "medium",
        withdrawalRisk: "medium",
        ukLicensed: true,
        requiresSwitchForTaper: false
      },
      {
        id: "paroxetine",
        name: "Paroxetine",
        class: "SSRI",
        commonDoses: [10, 20, 30, 40],
        halfLife: "short",
        withdrawalRisk: "high",
        ukLicensed: true,
        requiresSwitchForTaper: false
      },
      {
        id: "fluvoxamine",
        name: "Fluvoxamine",
        class: "SSRI",
        commonDoses: [50, 100, 150, 200],
        halfLife: "short",
        withdrawalRisk: "high",
        ukLicensed: true,
        requiresSwitchForTaper: false
      },

      /* SNRIs */
      {
        id: "venlafaxine_ir",
        name: "Venlafaxine IR (immediate-release / SR)",
        class: "SNRI",
        commonDoses: [37.5, 75, 112.5, 150, 225],
        halfLife: "short",
        withdrawalRisk: "very_high",
        ukLicensed: true,
        requiresSwitchForTaper: false
      },
      {
        id: "venlafaxine_mr",
        name: "Venlafaxine MR / XL (modified-release)",
        class: "SNRI",
        commonDoses: [75, 150, 225],
        halfLife: "short",
        withdrawalRisk: "very_high",
        ukLicensed: true,
        requiresSwitchForTaper: true  // taper via switch to IR or SSRI
      },
      {
        id: "duloxetine",
        name: "Duloxetine",
        class: "SNRI",
        commonDoses: [30, 60, 90, 120],
        halfLife: "medium",
        withdrawalRisk: "medium",
        ukLicensed: true,
        requiresSwitchForTaper: true  // taper via switch
      },

      /* NaSSA / atypical & other */
      {
        id: "mirtazapine",
        name: "Mirtazapine",
        class: "NaSSA",
        commonDoses: [15, 30, 45],
        halfLife: "medium",
        withdrawalRisk: "medium",
        ukLicensed: true,
        requiresSwitchForTaper: false
      },
      {
        id: "vortioxetine",
        name: "Vortioxetine",
        class: "Atypical",
        commonDoses: [5, 10, 20],
        halfLife: "long",
        withdrawalRisk: "low",
        ukLicensed: true,
        requiresSwitchForTaper: false
      },
      {
        id: "agomelatine",
        name: "Agomelatine",
        class: "Atypical",
        commonDoses: [25, 50],
        halfLife: "short",
        withdrawalRisk: "low",
        ukLicensed: true,
        requiresSwitchForTaper: false
      },
      {
        id: "trazodone",
        name: "Trazodone",
        class: "Atypical",
        commonDoses: [50, 100, 150, 300],
        halfLife: "short",
        withdrawalRisk: "medium",
        ukLicensed: true,
        requiresSwitchForTaper: false
      },
      {
        id: "bupropion",
        name: "Bupropion (Zyban – not licensed for depression in UK)",
        class: "NDRI",
        commonDoses: [150, 300],
        halfLife: "medium",
        withdrawalRisk: "low",
        ukLicensed: false,
        requiresSwitchForTaper: true  // usually switch first
      },

      /* TCAs and related */
      {
        id: "amitriptyline",
        name: "Amitriptyline",
        class: "TCA",
        commonDoses: [10, 25, 50, 75, 100, 150],
        halfLife: "long",
        withdrawalRisk: "high",
        ukLicensed: true,
        requiresSwitchForTaper: false
      },
      {
        id: "clomipramine",
        name: "Clomipramine",
        class: "TCA",
        commonDoses: [10, 25, 50, 75, 100, 150],
        halfLife: "medium",
        withdrawalRisk: "high",
        ukLicensed: true,
        requiresSwitchForTaper: false
      },
      {
        id: "dosulepin",
        name: "Dosulepin (dothiepin – not recommended for new starts)",
        class: "TCA",
        commonDoses: [25, 75, 150],
        halfLife: "long",
        withdrawalRisk: "high",
        ukLicensed: true,
        requiresSwitchForTaper: false
      },
      {
        id: "doxepin",
        name: "Doxepin",
        class: "TCA",
        commonDoses: [10, 25, 75],
        halfLife: "long",
        withdrawalRisk: "high",
        ukLicensed: true,
        requiresSwitchForTaper: false
      },
      {
        id: "imipramine",
        name: "Imipramine",
        class: "TCA",
        commonDoses: [10, 25, 50, 75, 100],
        halfLife: "long",
        withdrawalRisk: "high",
        ukLicensed: true,
        requiresSwitchForTaper: false
      },
      {
        id: "lofepramine",
        name: "Lofepramine",
        class: "TCA",
        commonDoses: [70, 140, 210],
        halfLife: "medium",
        withdrawalRisk: "medium",
        ukLicensed: true,
        requiresSwitchForTaper: false
      },
      {
        id: "maprotiline",
        name: "Maprotiline",
        class: "TCA",
        commonDoses: [25, 50, 75, 100, 150],
        halfLife: "long",
        withdrawalRisk: "high",
        ukLicensed: true,
        requiresSwitchForTaper: false
      },
      {
        id: "mianserin",
        name: "Mianserin",
        class: "TCA",
        commonDoses: [30, 60, 90],
        halfLife: "long",
        withdrawalRisk: "high",
        ukLicensed: true,
        requiresSwitchForTaper: false
      },
      {
        id: "nortriptyline",
        name: "Nortriptyline",
        class: "TCA",
        commonDoses: [10, 25, 50, 75],
        halfLife: "long",
        withdrawalRisk: "high",
        ukLicensed: true,
        requiresSwitchForTaper: false
      },
      {
        id: "trimipramine",
        name: "Trimipramine",
        class: "TCA",
        commonDoses: [25, 50, 75, 100],
        halfLife: "long",
        withdrawalRisk: "high",
        ukLicensed: true,
        requiresSwitchForTaper: false
      },

      /* MAOIs – specialist only */
      {
        id: "phenelzine",
        name: "Phenelzine (MAOI – specialist only)",
        class: "MAOI",
        commonDoses: [15, 30, 45, 60],
        halfLife: "medium",
        withdrawalRisk: "high",
        ukLicensed: true,
        specialistOnly: true,
        noAutoSwitch: true,
        requiresSwitchForTaper: false
      },
      {
        id: "tranylcypromine",
        name: "Tranylcypromine (MAOI – specialist only)",
        class: "MAOI",
        commonDoses: [10, 20, 30, 40],
        halfLife: "short",
        withdrawalRisk: "high",
        ukLicensed: true,
        specialistOnly: true,
        noAutoSwitch: true,
        requiresSwitchForTaper: false
      },
      {
        id: "isocarboxazid",
        name: "Isocarboxazid (MAOI – specialist only)",
        class: "MAOI",
        commonDoses: [10, 20, 30, 40, 60],
        halfLife: "medium",
        withdrawalRisk: "high",
        ukLicensed: true,
        specialistOnly: true,
        noAutoSwitch: true,
        requiresSwitchForTaper: false
      },
      {
        id: "moclobemide",
        name: "Moclobemide (reversible MAOI-A)",
        class: "MAOI",
        commonDoses: [150, 300, 450, 600],
        halfLife: "short",
        withdrawalRisk: "medium",
        ukLicensed: true,
        specialistOnly: true,
        noAutoSwitch: false,
        requiresSwitchForTaper: false
      }
    ];

    const commonOrder = [
      "sertraline",
      "citalopram",
      "fluoxetine",
      "escitalopram",
      "mirtazapine",
      "venlafaxine_mr",
      "venlafaxine_ir",
      "duloxetine",
      "amitriptyline",
      "lofepramine",
      "vortioxetine"
    ];

    const sortedAntidepressants = [...antidepressants].sort((a, b) => {
      const ia = commonOrder.indexOf(a.id);
      const ib = commonOrder.indexOf(b.id);
      if (ia !== -1 || ib !== -1) {
        if (ia === -1) return 1;
        if (ib === -1) return -1;
        return ia - ib;
      }
      return a.name.localeCompare(b.name);
    });

    function getDrugById(id) {
      return sortedAntidepressants.find(d => d.id === id);
    }

    function populateDrugSelect(selectEl) {
      selectEl.innerHTML = "";
      sortedAntidepressants.forEach(drug => {
        const opt = document.createElement("option");
        opt.value = drug.id;
        opt.textContent = drug.name;
        selectEl.appendChild(opt);
      });
    }

    function populateDoseSelect(drugId, selectEl, preferredValue) {
      const drug = getDrugById(drugId);
      selectEl.innerHTML = "";
      if (!drug) return;
      drug.commonDoses.forEach(dose => {
        const opt = document.createElement("option");
        opt.value = dose;
        opt.textContent = dose;
        selectEl.appendChild(opt);
      });
      if (preferredValue && [...selectEl.options].some(o => o.value === String(preferredValue))) {
        selectEl.value = String(preferredValue);
      }
    }

    // ==========================
    // Switching logic
    // ==========================
    function getCypCautions(from, to) {
      const cautions = [];
      if (from.id === "fluoxetine") {
        cautions.push("Fluoxetine has a long half-life; interactions and CYP2D6 inhibition may persist for 5–6 weeks after stopping.");
      }
      if (from.id === "paroxetine") {
        if (["duloxetine", "venlafaxine_ir", "venlafaxine_mr", "trazodone"].includes(to.id) || to.class === "TCA") {
          cautions.push("Paroxetine is a potent CYP2D6 inhibitor; may increase levels of " + to.name + ". Start at low dose and monitor closely.");
        }
      }
      if (from.id === "fluvoxamine") {
        if (["duloxetine", "agomelatine", "mirtazapine"].includes(to.id)) {
          cautions.push("Fluvoxamine is a potent CYP1A2 inhibitor; may increase levels of " + to.name + ". Start at low dose and monitor closely.");
        }
      }
      return cautions;
    }

    function getSwitchStrategy(from, to, currentDose) {
      if (from.specialistOnly || to.specialistOnly || from.class === "MAOI" || to.class === "MAOI") {
        return {
          mode: "unsupported",
          reason: "Switches involving MAOIs or specialist-only antidepressants should follow detailed SPS MAOI guidance and local mental health protocols."
        };
      }

      if (from.id === to.id) {
        return {
          mode: "same_drug",
          notes: "This is a dose adjustment rather than a switch. Consider gradual titration up or down and review response."
        };
      }

      const fromClass = from.class;
      const toClass = to.class;

      if (from.id === "fluoxetine") {
        return {
          mode: "taper_stop_start",
          taperWeeks: 2,
          washoutDays: 4,
          notes: "Reduce fluoxetine to 20 mg daily if higher, then stop. Wait 4–7 days before starting " + to.name + " at a low dose. Interactions may persist for 5–6 weeks."
        };
      }

      if (fromClass === "SSRI" && toClass === "SSRI") {
        return {
          mode: "direct",
          notes: "Direct switch is usually possible: stop " + from.name + " and start " + to.name +
            " the following day at usual starting dose. Consider cross-taper if high relapse risk or previous withdrawal."
        };
      }

      if (
        (fromClass === "SSRI" && (toClass === "SNRI" || toClass === "NaSSA" || toClass === "Atypical")) ||
        ((fromClass === "SNRI" || fromClass === "NaSSA" || fromClass === "Atypical") && toClass === "SSRI")
      ) {
        return {
          mode: "cross_taper",
          durationWeeks: 2,
          notes: "Cross-taper over around 2–4 weeks (quicker or slower depending on tolerability and risk)."
        };
      }

      if (fromClass === "SNRI" && toClass === "SNRI") {
        return {
          mode: "cross_taper",
          durationWeeks: 2,
          notes: "Cross-taper over around 2–4 weeks, monitoring BP and withdrawal."
        };
      }

      const fromIsModern = ["SSRI", "SNRI", "NaSSA", "Atypical", "NDRI"].includes(fromClass);
      const toIsModern = ["SSRI", "SNRI", "NaSSA", "Atypical", "NDRI"].includes(toClass);

      if ((fromIsModern && toClass === "TCA") || (fromClass === "TCA" && toIsModern)) {
        if (to.id === "clomipramine" || from.id === "clomipramine") {
          return {
            mode: "taper_stop_start",
            taperWeeks: 2,
            washoutDays: 0,
            notes: "Avoid cross-taper with clomipramine due to increased serotonin syndrome risk. Taper and stop the first drug, then start low-dose " +
              (to.id === "clomipramine" ? "clomipramine" : to.name) + " the following day."
          };
        } else {
          return {
            mode: "cautious_cross_or_taper",
            durationWeeks: 2,
            notes: "Either taper and stop the first antidepressant before starting the second at low dose, or perform a cautious cross-taper over 2–4 weeks depending on interaction risk."
          };
        }
      }

      if (fromClass === "TCA" && toClass === "TCA") {
        return {
          mode: "cross_taper",
          durationWeeks: 2,
          notes: "Taper first TCA while titrating the second up over 2–4 weeks. Avoid excessive total TCA dose."
        };
      }

      return {
        mode: "cross_taper",
        durationWeeks: 2,
        notes: "Use a cautious cross-taper over ~2–4 weeks and consult SPS switching tables for this specific pair."
      };
    }

    function generateSwitchPlan(fromDrugId, fromDose, toDrugId) {
      const from = getDrugById(fromDrugId);
      const to = getDrugById(toDrugId);
      const dose = Number(fromDose);

      if (!from || !to) {
        return { clinician: "Please select both a current and a new antidepressant.", sms: "" };
      }

      const strategy = getSwitchStrategy(from, to, dose);

      if (strategy.mode === "unsupported") {
        const clinicianText =
          `Switch from ${from.name} ${dose} mg OD to ${to.name}\n\n` +
          `Automated plan not provided.\n` +
          `• ${strategy.reason}\n` +
          `• Refer to SPS MAOI / specialist switching guidance and local Trust or ICB protocols.\n` +
          `• Consider discussion with psychiatry / mental health pharmacist.\n`;

        const smsText =
          `Your medication plan\n\n` +
          `You are changing from ${from.name} to ${to.name}. Because of the type of medicines involved, ` +
          `your GP or specialist will agree a personalised plan with you rather than using an automatic schedule.`;

        return { clinician: clinicianText, sms: smsText };
      }

      const cypCautions = getCypCautions(from, to);
      const scheduleLines = [];
      const doseTextFrom = `${from.name} ${dose} mg once daily`;

      switch (strategy.mode) {
        case "direct":
          scheduleLines.push(
            `Stop ${doseTextFrom}, and start ${to.name} at usual starting dose (e.g. ${to.commonDoses[0]} mg once daily) the following day.`
          );
          break;

        case "cross_taper":
          const doses = from.commonDoses.filter(d => d <= dose).sort((a, b) => b - a);
          const nextLower = doses[1] || Math.max(dose / 2, doses[doses.length - 1] || dose / 2);
          scheduleLines.push(
            `Week 1–2: Reduce ${from.name} from ${dose} mg to ${nextLower} mg once daily and start ${to.name} at a low dose (e.g. ${to.commonDoses[0]} mg once daily).`,
            `Week 3–4: Stop ${from.name}. Increase ${to.name} towards target dose as tolerated.`
          );
          break;

        case "cautious_cross_or_taper":
          scheduleLines.push(
            `Option 1 – taper then start: reduce ${from.name} gradually over ~2–4 weeks and stop, then start low-dose ${to.name} the following day.`,
            `Option 2 – cautious cross-taper over ~2–4 weeks where interaction risk is low and close monitoring is possible.`
          );
          break;

        case "taper_stop_start":
          scheduleLines.push(
            `Weeks 1–2: Gradually reduce ${from.name} (e.g. reduce to 50% of current dose, then if fluoxetine consider 20 mg daily).`,
            `Then stop ${from.name} and wait ${strategy.washoutDays || 0}–${(strategy.washoutDays || 0) + 3} days.`,
            `Start ${to.name} at low dose (e.g. ${to.commonDoses[0]} mg once daily) and titrate according to response.`
          );
          break;

        case "same_drug":
          scheduleLines.push(`This is a dose adjustment of ${from.name} rather than a switch. Consider gradual titration and regular review.`);
          break;

        default:
          scheduleLines.push("Use a cautious cross-taper over 2–4 weeks, guided by SPS and local guidance.");
      }

      const standardCautions = [
        "Warned about possible transient increase in anxiety, GI upset, sleep disturbance and withdrawal symptoms during the switch.",
        "Advised on risk of serotonin syndrome, particularly when drugs overlap.",
        "Advised to seek urgent help (111/999/A&E) if severe agitation, confusion, fever, sweating, tremor, diarrhoea or thoughts of self-harm occur.",
        "Plan for review within 2–4 weeks, sooner if high risk."
      ];

      const clinicianText =
        `Plan – switch from ${from.name} ${dose} mg OD to ${to.name}\n\n` +
        scheduleLines.map(l => `• ${l}`).join("\n") +
        `\n\nRationale & cautions:\n` +
        `• ${strategy.notes}\n` +
        (cypCautions.length ? cypCautions.map(c => `• ${c}`).join("\n") + "\n" : "") +
        standardCautions.map(c => `• ${c}`).join("\n") +
        `\n\nBased on high-level principles from NICE NG222 and SPS switching strategies; check detailed SPS tables for this specific pair.`;

      let smsText = `Your medication plan\n\nYou are changing from ${from.name} ${dose} mg daily to ${to.name}.\n\n`;

      if (strategy.mode === "direct") {
        smsText +=
          `Stop ${from.name} and start ${to.name} at the usual starting dose the next day (your GP will confirm the exact dose).\n\n`;
      } else if (strategy.mode === "cross_taper" || strategy.mode === "cautious_cross_or_taper") {
        smsText +=
          `We will gradually reduce ${from.name} while starting ${to.name} at a low dose over a few weeks.\n\n`;
      } else if (strategy.mode === "taper_stop_start") {
        smsText +=
          `We will slowly reduce ${from.name}, then have a short gap before starting ${to.name} at a low dose.\n\n`;
      } else if (strategy.mode === "same_drug") {
        smsText +=
          `We are adjusting the dose of ${from.name} gradually rather than changing to a new medicine.\n\n`;
      }

      smsText +=
        `Contact the surgery, NHS 111 or 999/A&E urgently if you feel very agitated, confused, feverish, ` +
        `have severe diarrhoea, or have thoughts of harming yourself.`;

      return { clinician: clinicianText, sms: smsText };
    }

    // ==========================
    // Stopping logic – discrete, BNF-realistic
    // ==========================
    function generateDiscreteTaperSteps(drug, startDose, durationBand) {
      let baseSteps;
      switch (durationBand) {
        case "short": baseSteps = 2; break;
        case "medium": baseSteps = 3; break;
        case "long": baseSteps = 4; break;
        case "very_long": baseSteps = 5; break;
        default: baseSteps = 3;
      }

      let steps = baseSteps;
      if (drug.withdrawalRisk === "very_high") steps += 2;
      else if (drug.withdrawalRisk === "high") steps += 1;
      if (drug.halfLife === "long") steps = Math.max(2, steps - 1);
      steps = Math.min(8, Math.max(2, steps));

      let weeksPerStep = 2;
      if (durationBand === "short") weeksPerStep = 1;
      if (durationBand === "very_long") weeksPerStep = 3;
      if (drug.withdrawalRisk === "very_high" || drug.withdrawalRisk === "high") {
        weeksPerStep = Math.max(2, weeksPerStep);
      }

      const allowed = drug.commonDoses
        .filter(d => d <= startDose)
        .sort((a, b) => b - a);

      if (!allowed.includes(startDose)) {
        allowed.unshift(startDose);
      }

      const doseSequence = [];
      let current = startDose;
      doseSequence.push(current);

      for (let i = 0; i < allowed.length; i++) {
        const d = allowed[i];
        if (d === current) {
          const next = allowed[i + 1];
          if (next !== undefined) {
            doseSequence.push(next);
            current = next;
          }
        }
      }

      const maxDoseSteps = steps - 1;
      const truncatedDoses = doseSequence.slice(0, maxDoseSteps);

      const schedule = [];
      truncatedDoses.forEach((d, index) => {
        const stepIndex = index + 1;
        const startWeek = (stepIndex - 1) * weeksPerStep + 1;
        const endWeek = stepIndex * weeksPerStep;
        schedule.push({
          step: stepIndex,
          dose: d,
          startWeek,
          endWeek
        });
      });

      const finalStepIndex = truncatedDoses.length + 1;
      const finalStartWeek = (finalStepIndex - 1) * weeksPerStep + 1;
      const finalEndWeek = finalStepIndex * weeksPerStep;
      schedule.push({
        step: finalStepIndex,
        dose: 0,
        startWeek: finalStartWeek,
        endWeek: finalEndWeek
      });

      return { schedule, weeksPerStep };
    }

    function generateStopPlan(drugId, dose, durationBand) {
      const drug = getDrugById(drugId);
      const startDose = Number(dose);
      if (!drug || !startDose) {
        return { clinician: "Please select a drug and dose.", sms: "" };
      }

      const { schedule } = generateDiscreteTaperSteps(drug, startDose, durationBand);

      const lines = schedule.map(s => {
        if (s.dose === 0) {
          return `Weeks ${s.startWeek}–${s.endWeek}: stop ${drug.name} if stable and withdrawal symptoms are manageable.`;
        } else {
          return `Weeks ${s.startWeek}–${s.endWeek}: ${drug.name} ${s.dose} mg once daily.`;
        }
      });

      const durationTextMap = {
        short: "< 6 weeks",
        medium: "6 weeks – 6 months",
        long: "6 – 24 months",
        very_long: "> 2 years"
      };
      const durationText = durationTextMap[durationBand] || "unspecified";

      const clinicianText =
        `Plan – gradual reduction of ${drug.name} ${startDose} mg OD (duration: ${durationText})\n\n` +
        lines.map(l => `• ${l}`).join("\n") +
        `\n\nRationale & counselling:\n` +
        `• Uses discrete tablet/capsule strengths in line with UK BNF (no unachievable doses).\n` +
        `• Number and spacing of steps adjusted for withdrawal risk and duration of treatment.\n` +
        `• Advised patient about withdrawal symptoms (dizziness, "electric shocks", flu-like symptoms, sleep disturbance, anxiety, low mood) and difference from relapse.\n` +
        `• Advised to contact the surgery if withdrawal is severe/persistent or if depressive symptoms return; consider pausing or slowing taper.\n` +
        `• Documented crisis/safety netting (self-harm, suicidal ideation) and agreed review plan.\n`;

      const smsText =
        `Plan to reduce ${drug.name}\n\n` +
        `You are on ${drug.name} ${startDose} mg daily. We will reduce this gradually:\n` +
        lines.map(l => "- " + l.replace(`${drug.name} `, "")).join("\n") +
        `\n\nIf you get severe dizziness, strange "electric shock" feelings, very low mood or thoughts of harming yourself, ` +
        `contact the surgery, NHS 111 or 999/A&E urgently.`;

      return { clinician: clinicianText, sms: smsText };
    }

    // ==========================
    // Taper pathway chooser (modal)
    // ==========================
    function getTaperOptionsForDrug(drug, startDose, durationBand) {
      const options = [];

      if (drug.id === "venlafaxine_mr") {
        options.push({
          id: "opt_venla_ir",
          label: "Switch to venlafaxine IR then taper",
          taperDrugId: "venlafaxine_ir",
          taperStartDose: startDose
        });
        options.push({
          id: "opt_sertraline",
          label: "Switch to sertraline then taper",
          taperDrugId: "sertraline",
          taperStartDose: startDose <= 75 ? 50 : 100
        });
      } else if (drug.id === "duloxetine") {
        options.push({
          id: "opt_sertraline",
          label: "Switch to sertraline then taper",
          taperDrugId: "sertraline",
          taperStartDose: 50
        });
        options.push({
          id: "opt_venla_ir",
          label: "Switch to venlafaxine IR then taper",
          taperDrugId: "venlafaxine_ir",
          taperStartDose: startDose <= 30 ? 37.5 : 75
        });
      } else if (drug.id === "bupropion") {
        options.push({
          id: "opt_sertraline",
          label: "Switch to sertraline then taper",
          taperDrugId: "sertraline",
          taperStartDose: startDose <= 150 ? 50 : 100
        });
        options.push({
          id: "opt_fluoxetine",
          label: "Switch to fluoxetine then taper",
          taperDrugId: "fluoxetine",
          taperStartDose: 20
        });
      } else {
        options.push({
          id: "opt_sertraline",
          label: "Switch to sertraline then taper",
          taperDrugId: "sertraline",
          taperStartDose: 50
        });
      }

      options.forEach(opt => {
        const examplePlan = generateStopPlan(opt.taperDrugId, opt.taperStartDose, durationBand);
        const lines = examplePlan.clinician.split("\n").filter(l => l.trim().startsWith("• Weeks"));
        opt.description = `Example taper for ${getDrugById(opt.taperDrugId).name} ${opt.taperStartDose} mg OD:\n` +
          (lines.length ? lines.join("\n") : "(see detailed plan after confirmation)");
      });

      return options;
    }

    function openTaperModal(context) {
      pendingTaperContext = context;
      selectedTaperOptionId = null;

      const overlay = document.getElementById("taperModalOverlay");
      const optionsContainer = document.getElementById("taperModalOptions");
      const confirmBtn = document.getElementById("taperModalConfirm");

      const sourceDrug = getDrugById(context.sourceDrugId);
      document.getElementById("taperModalIntro").textContent =
        `This medication (${sourceDrug.name} ${context.sourceDose} mg) cannot be tapered safely using its available UK BNF strengths alone. ` +
        `Choose an intermediate medication to switch to first, then taper that. An example taper is shown for each option.`;

      pendingTaperOptions = getTaperOptionsForDrug(
        sourceDrug,
        Number(context.sourceDose),
        context.durationBand
      );

      optionsContainer.innerHTML = "";
      pendingTaperOptions.forEach(opt => {
        const div = document.createElement("div");
        div.className = "modal-option";
        div.dataset.optionId = opt.id;

        const title = document.createElement("div");
        title.className = "modal-option-title";
        title.textContent = opt.label;

        const body = document.createElement("div");
        body.className = "modal-option-body";
        body.textContent = opt.description;

        div.appendChild(title);
        div.appendChild(body);
        optionsContainer.appendChild(div);
      });

      confirmBtn.disabled = true;

      overlay.classList.remove("hidden");
      overlay.style.display = "flex";

      lastFocusedElementBeforeModal = document.activeElement;
      confirmBtn.focus();
    }

    function closeTaperModal() {
      const overlay = document.getElementById("taperModalOverlay");
      overlay.classList.add("hidden");
      overlay.style.display = "none";

      pendingTaperContext = null;
      pendingTaperOptions = [];
      selectedTaperOptionId = null;

      if (lastFocusedElementBeforeModal && typeof lastFocusedElementBeforeModal.focus === "function") {
        lastFocusedElementBeforeModal.focus();
      }
    }

    function confirmTaperModalChoice() {
      if (!pendingTaperContext || !selectedTaperOptionId) return;
      const option = pendingTaperOptions.find(o => o.id === selectedTaperOptionId);
      if (!option) return;

      const sourceDrug = getDrugById(pendingTaperContext.sourceDrugId);
      const taperDrug = getDrugById(option.taperDrugId);
      const taperPlan = generateStopPlan(option.taperDrugId, option.taperStartDose, pendingTaperContext.durationBand);

      const clinicianText =
        `Step 1 – switch for tapering\n` +
        `• Switch from ${sourceDrug.name} ${pendingTaperContext.sourceDose} mg OD to ${taperDrug.name} ${option.taperStartDose} mg OD as an intermediate antidepressant to facilitate a more gradual taper (see NICE/SPS).\n\n` +
        `Step 2 – taper ${taperDrug.name}\n\n` +
        taperPlan.clinician;

      const smsText =
        `Plan to reduce your medication\n\n` +
        `First we will change you from ${sourceDrug.name} to ${taperDrug.name} ${option.taperStartDose} mg daily. ` +
        `Once you are settled on this, we will gradually reduce ${taperDrug.name}:\n\n` +
        taperPlan.sms;

      document.getElementById("stopClinician").textContent = clinicianText;
      document.getElementById("stopSMS").textContent = smsText;

      closeTaperModal();
    }

    // ==========================
    // Copy to clipboard
    // ==========================
    function copyToClipboard(text) {
      if (!navigator.clipboard) {
        const textarea = document.createElement("textarea");
        textarea.value = text;
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand("copy");
        textarea.remove();
        return;
      }
      navigator.clipboard.writeText(text).catch(() => {
        const textarea = document.createElement("textarea");
        textarea.value = text;
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand("copy");
        textarea.remove();
      });
    }

    // ==========================
    // State persistence
    // ==========================
    const STORAGE_KEY = "switchStopADState";

    function loadState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return {};
        return JSON.parse(raw);
      } catch {
        return {};
      }
    }

    function saveState(partial) {
      const existing = loadState();
      const merged = { ...existing, ...partial };
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(merged));
      } catch {
        // ignore if storage unavailable
      }
    }

    // ==========================
    // Global click handlers
    // ==========================
    document.addEventListener("click", (e) => {
      // Copy buttons
      if (e.target.classList.contains("copy-btn")) {
        const targetId = e.target.dataset.target;
        const contentEl = document.getElementById(targetId);
        if (!contentEl) return;
        const content = contentEl.textContent.trim();
        if (!content) return;

        copyToClipboard(content);

        const btn = e.target;
        const original = btn.textContent;
        btn.textContent = "Copied!";
        btn.classList.add("copied");
        setTimeout(() => {
          btn.textContent = original;
          btn.classList.remove("copied");
        }, 1500);
      }

      // Modal option selection
      if (e.target.classList.contains("modal-option")) {
        const options = document.querySelectorAll(".modal-option");
        options.forEach(o => o.classList.remove("selected"));
        e.target.classList.add("selected");
        selectedTaperOptionId = e.target.dataset.optionId;
        document.getElementById("taperModalConfirm").disabled = false;
      }

      // Clicking outside the modal (on overlay)
      const overlay = document.getElementById("taperModalOverlay");
      if (e.target === overlay) {
        closeTaperModal();
      }
    });

    // Escape key to close modal
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") {
        const overlay = document.getElementById("taperModalOverlay");
        if (overlay && !overlay.classList.contains("hidden")) {
          closeTaperModal();
        }
      }
    });

    // ==========================
    // Main UI wiring
    // ==========================
    document.addEventListener("DOMContentLoaded", () => {
      const fromDrugSelect = document.getElementById("fromDrug");
      const fromDoseSelect = document.getElementById("fromDose");
      const toDrugSelect = document.getElementById("toDrug");

      const stopDrugSelect = document.getElementById("stopDrug");
      const stopDoseSelect = document.getElementById("stopDose");
      const durationSelect = document.getElementById("duration");

      const tabButtons = document.querySelectorAll(".tab-button");
      const tabs = {
        switching: document.getElementById("switching"),
        stopping: document.getElementById("stopping")
      };

      const overlay = document.getElementById("taperModalOverlay");
      if (overlay) {
        overlay.classList.add("hidden");
        overlay.style.display = "none";
      }

      userHasClickedGenerateStop = false;

      const state = loadState();

      // Populate drug selects
      populateDrugSelect(fromDrugSelect);
      populateDrugSelect(toDrugSelect);
      populateDrugSelect(stopDrugSelect);

      // Restore or default values
      if (state.fromDrug && getDrugById(state.fromDrug)) {
        fromDrugSelect.value = state.fromDrug;
      }
      populateDoseSelect(fromDrugSelect.value, fromDoseSelect, state.fromDose);

      if (state.toDrug && getDrugById(state.toDrug)) {
        toDrugSelect.value = state.toDrug;
      }

      if (state.stopDrug && getDrugById(state.stopDrug)) {
        stopDrugSelect.value = state.stopDrug;
      }
      populateDoseSelect(stopDrugSelect.value, stopDoseSelect, state.stopDose);

      if (state.duration) {
        durationSelect.value = state.duration;
      }

      // Restore active tab
      const initialTab = state.activeTab === "stopping" ? "stopping" : "switching";
      tabButtons.forEach(b => b.classList.remove("active"));
      document.querySelector(`.tab-button[data-tab="${initialTab}"]`).classList.add("active");
      Object.keys(tabs).forEach(id => {
        tabs[id].classList.toggle("hidden", id !== initialTab);
      });

      // Event listeners for selects to save state
      fromDrugSelect.addEventListener("change", () => {
        populateDoseSelect(fromDrugSelect.value, fromDoseSelect);
        saveState({ fromDrug: fromDrugSelect.value, fromDose: fromDoseSelect.value });
      });

      fromDoseSelect.addEventListener("change", () => {
        saveState({ fromDrug: fromDrugSelect.value, fromDose: fromDoseSelect.value });
      });

      toDrugSelect.addEventListener("change", () => {
        saveState({ toDrug: toDrugSelect.value });
      });

      stopDrugSelect.addEventListener("change", () => {
        populateDoseSelect(stopDrugSelect.value, stopDoseSelect);
        saveState({ stopDrug: stopDrugSelect.value, stopDose: stopDoseSelect.value });
      });

      stopDoseSelect.addEventListener("change", () => {
        saveState({ stopDrug: stopDrugSelect.value, stopDose: stopDoseSelect.value });
      });

      durationSelect.addEventListener("change", () => {
        saveState({ duration: durationSelect.value });
      });

      // Generate switch
      document.getElementById("generateSwitch").addEventListener("click", () => {
        const res = generateSwitchPlan(fromDrugSelect.value, fromDoseSelect.value, toDrugSelect.value);
        document.getElementById("switchClinician").textContent = res.clinician;
        document.getElementById("switchSMS").textContent = res.sms;
      });

      document.getElementById("clearSwitch").addEventListener("click", () => {
        document.getElementById("switchClinician").textContent = "";
        document.getElementById("switchSMS").textContent = "";
      });

      // Generate stop
      document.getElementById("generateStop").addEventListener("click", () => {
        userHasClickedGenerateStop = true;

        const drugId = stopDrugSelect.value;
        const dose = stopDoseSelect.value;
        const durationBand = durationSelect.value;
        const drug = getDrugById(drugId);

        if (!drug || !dose) {
          document.getElementById("stopClinician").textContent = "Please select a drug and dose.";
          document.getElementById("stopSMS").textContent = "";
          return;
        }

        if (drug.requiresSwitchForTaper && userHasClickedGenerateStop) {
          openTaperModal({
            sourceDrugId: drugId,
            sourceDose: dose,
            durationBand
          });
          return;
        }

        const res = generateStopPlan(drugId, dose, durationBand);
        document.getElementById("stopClinician").textContent = res.clinician;
        document.getElementById("stopSMS").textContent = res.sms;
      });

      document.getElementById("clearStop").addEventListener("click", () => {
        document.getElementById("stopClinician").textContent = "";
        document.getElementById("stopSMS").textContent = "";
      });

      // Modal buttons
      document.getElementById("taperModalCancel").addEventListener("click", () => {
        closeTaperModal();
      });

      document.getElementById("taperModalConfirm").addEventListener("click", () => {
        confirmTaperModalChoice();
      });

      // Tab switching
      tabButtons.forEach(btn => {
        btn.addEventListener("click", () => {
          const tabId = btn.dataset.tab;
          tabButtons.forEach(b => b.classList.remove("active"));
          btn.classList.add("active");
          Object.keys(tabs).forEach(id => {
            tabs[id].classList.toggle("hidden", id !== tabId);
          });
          saveState({ activeTab: tabId });
        });
      });

      // Ensure outputs start empty (no auto-generation)
      document.getElementById("switchClinician").textContent = "";
      document.getElementById("switchSMS").textContent = "";
      document.getElementById("stopClinician").textContent = "";
      document.getElementById("stopSMS").textContent = "";
    });
  </script>
</body>
</html>
